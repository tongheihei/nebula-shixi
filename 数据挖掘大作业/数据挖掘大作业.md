[toc]

# 异常乘客识别

## 1.任务描述

在给定的数据集当中，寻找购票行为异常的乘客，通常情况下，认为这些异常的乘客很有可能是小偷。

## 2.原始数据

|     字段      |     含义     |
| :-----------: | :----------: |
|     PR_ID     | 当前订单标识 |
|     PPID      | 乘车人身份证 |
|  TRAIN_TYPE   |   火车种类   |
|  TRAIN_CODE   |    火车号    |
|  BOARD_DATE   |   上车日期   |
|  BOARD_TIME   |   上车时间   |
| ARRIVAL_DATE  |   到达日期   |
| ARRIVAL_TIME  |   到达时间   |
|   START_STA   |    出发站    |
|  ARRIVAL_STA  |    到达站    |
|  TAVEL_TIME   |   旅途时间   |
| TRAVEL_LENGTH |     旅程     |
|   SEAT_TYPE   |   车票类型   |
|   COACH_NO    |    车厢号    |
|    SEAT_NO    |    座位号    |
|  BUYYER_PID   | 购买人身份证 |

- **相关参数解释**:

TRAIN_TYPE:分为普通列车，D，K，Z， T这五类。

SEAT_TYPE:分为GD，RZ，YZ，ZP这四类。

### 2.1 原始数据分布图

- **原始数据相关分布图**
  
  - 出发年份，月份，日期分布图
  
  <img src="/Users/taolei/Library/Application Support/typora-user-images/image-20210705104155005.png" alt="image-20210705104155005" style="zoom:200%;" />     
  
  <img src="/Users/taolei/Library/Application Support/typora-user-images/image-20210705104127866.png" alt="image-20210705104127866" style="zoom:200%;" /><img src="/Users/taolei/Library/Application Support/typora-user-images/image-20210705104331833.png" alt="image-20210705104331833" style="zoom:200%;" />
  
  **Explain**：可以看出此数据集的所有车票均在2012购得，且此数据集出发时间的分布较为均匀。

  - 到达年份，月份，日期分布图

  <img src="/Users/taolei/Library/Application Support/typora-user-images/image-20210705104743029.png" alt="image-20210705104743029" style="zoom:200%;" />
  <img src="/Users/taolei/Library/Application Support/typora-user-images/image-20210705104801117.png" alt="image-20210705104801117" style="zoom:200%;" /><img src="/Users/taolei/Library/Application Support/typora-user-images/image-20210705104820685.png" alt="image-20210705104820685" style="zoom:200%;" />

  **Explain**：可以看出此数据集的所有车票均在2012到达，且此数据集到达时间的分布较为均匀。

  - 出发时间分布
  
    <img src="/Users/taolei/Library/Application Support/typora-user-images/image-20210705105941188.png" alt="image-20210705105941188" style="zoom:200%;" />

  **Explain**:可以看出乘车时间基本分布在8-22时，凌晨乘车的车票相对较少
  
  - 出发与到达站点分布
  
    ![image-20210705110729732](/Users/taolei/Library/Application Support/typora-user-images/image-20210705110729732.png)![image-20210705110955841](/Users/taolei/Library/Application Support/typora-user-images/image-20210705110955841.png)

  **Explain**:可以看出站点的数量极其多，且有少数站台是最经常用的站。

  - 乘客分布情况
  
    ![image-20210705111556404](/Users/taolei/Library/Application Support/typora-user-images/image-20210705111556404.png)

  **Explain**:可以看出大多数乘客的乘坐的次数是非常少的，但是也有乘客有超于常人的乘车次数。
  
  - 乘车时间分布情况
  
    <img src="/Users/taolei/Library/Application Support/typora-user-images/image-20210705114212011.png" alt="image-20210705114212011" style="zoom:75%;" />

  **Explain:**行车里程以中短程为主，长里程较少，且在0-500内的行程占超过了80%。

  - 座位类型分布
  
  ![image-20210705114613164](/Users/taolei/Library/Application Support/typora-user-images/image-20210705114613164.png)

  **Explian**:可以看出普通座位的乘客居多，而一等，商务座的乘客明显较普通乘客少很多。

### 2.2 原始数据总结

- 一共包含了11077个乘车人的985760条数据，其中存在空数据，但空数据只存在在出发站与到达站，我们把这种空数据当作乘车人的逃票行为。
- 出发时间，出发日期，出发时间等相关分布较为均匀，因此如果作为特征来提取的话不能区分异常，故在特征向量中不加入此特征。
- 由于极长时的里程极少，所以并不用区分某趟车票是否隔天。
- 由于是否夜间乘车分布的也很均匀，所以想以此来区分异常可能效果不理想。
- 有一部分乘客在上车站点，下车站点中有空值，此部分乘客极有可能成为小偷(异常乘客)。

### 2.3 小偷的心理

- 小偷在没有被抓到的基础上，会反复多次作案，因此小偷的乘车次数会多于一般的普通人。
- **作为小偷，既然盗窃是犯罪，自然其他情况也可能违法，那么小偷逃票的概率非常大，即出发站或者到达站为空站点的时候，此人为小偷的概率极其大。**(实验表明此数据在)
- 人在夜间容易放松防备心理，且会疲惫，因此小偷在夜间的概率极其大。
- 不能一直在一辆火车上作案，需要经常换作案的火车，因此小偷乘坐的不同的火车号数会非常多。
- 小偷经常在中途站下车，作案完成后，就算没有到达终点站可能也会提前逃跑。但此数据集只有出发站和到达站，没有下车站。
## 3.特征选择

|        字段         |           含义            |
| :-----------------: | :-----------------------: |
|    Total_ticket     |       总共乘车次数        |
|    Night_ticket     |       夜间乘车次数        |
|     Night_scale     |       夜间乘车比例        |
|    seat_gd_scale    |    乘坐高等座次的比例     |
|   long_time_scale   |     车票为长途的比例      |
| long_distance_scale |    车票为长距离的比例     |
|    TYPE_D_scale     | 乘坐的类型为D的动车的比例 |
|   season_1_scale    |    第一季度乘车的比例     |
|   season_2_scale    |    第一季度乘车的比例     |
|   season_3_scale    |    第一季度乘车的比例     |
|   season_4_scale    |    第一季度乘车的比例     |
|   max_place_scale   |      最多路程的比例       |
|    total_escape     |        逃票的次数         |
| total_escape_scale  |        逃票的比例         |
|    total_chezhan    |   总共乘坐过的车站个数    |
|         PID         |            ID             |



- total_ticket

  小偷一般是惯犯，在盗窃成功后会想继续下一步盗窃行为，因此他们的乘车次数一般较多，故在算法中我们去掉了乘车次数少于50的乘客。对total_ticket的处理方式为min_max归一化，使其成为特征向量中的一维。
  
- night_ticket

  人在夜间的时候是精力最不集中的时候，同时也是小偷最好下手的时候，趁着人精力不集中更好实施盗窃行为。对night_ticket的处理方式为进行min_max归一化。

- night_scale

  除了看总量，还要查看夜间乘车的比例，此特征为连续型特征。

- Seat_gd_scale

  小偷不会花费大价钱来实施盗窃行为，因为火车的各个车厢是通的，因此他们随便在哪个类型的车座，执行盗窃的对象都是所有人，所以购买高等座次没有意义。此特征为连续型特征。

- Type_D_scale

  同样，不同动车类型价格也不一样，小偷同样不会大费周章在动车类型上，此特征有四维，为连续型特征。

- Season_1_scale

  正常通勤的人，不同季度乘车比例应该是差不多的，只有异常乘客（小偷（的乘车比例不一样，此特征为连续型特征。

- Season_2_scale

  同上

- Season_3_scale

  同上

- Season_4_scale

  同上

- Max_place_scale

  正常人经过的动车路线一般都是比较固定的，而异常乘客会选择不同的动车进行作案，此特征为连续型特征。

- Total_escape

  总共的逃票次数，作为小偷，既然盗窃是犯罪，自然其他情况也可能违法，那么小偷逃票的概率非常大，即出发站或者到达站为空站点的时候，此人为小偷的概率极其大，此特征进行min-max归一化处理。

- Total_escape_scale

  总共的逃票比例，逃票比例高的更加有可能是小偷。这个特征为连续型特征。

- Total_chezhan

  总共经历的车站个数，小偷会挑选不同的车站作案，因此这个特征的数量会比普通人高。此特征进行min-max归一化处理

- PID

  此特征仅用来最后认证异常值。

  
## 4.算法选用

### 4.1 DBSCAN

#### 4.1.1算法描述

DBSCAN 算法是一种基于密度的聚类算法：
　　1.聚类的时候不需要预先指定簇的个数
　　2.最终的簇的个数不确定
DBSCAN算法将数据点分为三类：
　　1.核心点：在半径Eps内含有超过MinPts数目的点。
　　2.边界点：在半径Eps内点的数量小于MinPts,但是落在核心点的邻域内的点。
　　3.噪音点：既不是核心点也不是边界点的点。

#### 4.1.2算法流程

1.将所有点标记为核心点、边界点或噪声点；
2.删除噪声点；
3.为距离在Eps之内的所有核心点之间赋予一条边；
4.每组连通的核心点形成一个簇；
5.将每个边界点指派到一个与之关联的核心点的簇中（哪一个核心点的半径范围之内）。

![image-20210709230414176](/Users/taolei/Library/Application Support/typora-user-images/image-20210709230414176.png)

#### 4.1.3算法优缺点总结

DBSCAN的主要优点有：

- 可以对任意形状的稠密数据集进行聚类，相对的，K-Means之类的聚类算法一般只适用于凸数据集。

- 可以在聚类的同时发现异常点，对数据集中的异常点不敏感。
- 聚类结果没有偏倚，相对的，K-Means之类的聚类算法初始值对聚类结果有很大影响。

DBSCAN的主要缺点有：

- 如果样本集的密度不均匀、聚类间距差相差很大时，聚类质量较差，这时用DBSCAN聚类一般不适合。

- 如果样本集较大时，聚类收敛时间较长，此时可以对搜索最近邻时建立的KD树或者球树进行规模限制来改进。

- 调参相对于传统的K-Means之类的聚类算法稍复杂，主要需要对距离阈值𝜖ϵ，邻域样本数阈值MinPts联合调参，不同的参数组合对最后的聚类效果有较大影响。

### 4.2 IsolationForest

#### 4.2.1算法描述

针对于不同类型的异常，要用不同的算法来进行检测，而孤立森林算法主要针对的是连续型结构化数据中的异常点。

使用孤立森林的前提是，将异常点定义为那些 “容易被孤立的离群点” —— 可以理解为分布稀疏，且距离高密度群体较远的点。从统计学来看，在数据空间里，若一个区域内只有分布稀疏的点，表示数据点落在此区域的概率很低，因此可以认为这些区域的点是异常的。

孤立森林算法是基于 Ensemble 的异常检测方法，因此具有线性的时间复杂度。且精准度较高，在处理大数据时速度快，所以目前在工业界的应用范围比较广。常见的场景包括：网络安全中的攻击检测、金融交易欺诈检测、疾病侦测、噪声数据过滤（数据清洗）等。

#### 4.2.2算法流程

- 从训练数据中随机选择 Ψ 个点作为子样本，放入一棵孤立树的根节点；
- 随机指定一个维度，在当前节点数据范围内，随机产生一个切割点 p —— 切割点产生于当前节点数据中指定维度的最大值与最小值之间；
- 此切割点的选取生成了一个超平面，将当前节点数据空间切分为2个子空间：把当前所选维度下小于 p 的点放在当前节点的左分支，把大于等于 p 的点放在当前节点的右分支；
- 在节点的左分支和右分支节点递归步骤 2、3，不断构造新的叶子节点，直到叶子节点上只有一个数据（无法再继续切割） 或树已经生长到了所设定的高度 。

#### 4.2.3算法优缺点总结

  孤立森林的主要优点:

- 孤立森林算法内存要求低，处理速度快，时间复杂度是线性的，可以处理高维数据和大数据，可以进行在线预测。
- 既能发现群异常数据，也能发现散点异常数据，也能处理训练数据中不包含异常数据的情况；

孤立森林的主要缺点:

- 孤立森林的基础是“使用随机超平面分割空间”，这就有点随意、没法解释。像法律事务这样严肃的任务，解释性低是一个模型的致命缺陷。

## 5.实验结果



### 5.1 DBSCAN实验结果

- 参数选择

  ![image-20210709232334109](/Users/taolei/Library/Application Support/typora-user-images/image-20210709232334109.png)

  **Description**:在扫描半径eps为0.26时，算法异常率基本不变化，因此我们把最终扫描半径认定为0.26.

- 实验结果

  在eps为0.26时，我们一共发现了10名异常乘客，5809名正常乘客，如下图所示

  ![image-20210709232901666](/Users/taolei/Library/Application Support/typora-user-images/image-20210709232901666.png)、

  这十位异常乘客分别为

  ![image-20210709232948413](/Users/taolei/Library/Application Support/typora-user-images/image-20210709232948413.png)

  他们的特点是:

  - **出发和到达站点中存在大量空值，且去掉空值后剩下的出行记录极少**
  - **出发站和到达站中的站点十分分散**
  - **行程缺乏接续性（即并不是我们所认为的通勤人员）**

### 5.2 Isolation Forest实验结果

Isolation Forest算法用来验证找到的异常，使用孤立森林，在n_estimators=900时，我们一共找到11个异常点![image-20210709235232923](/Users/taolei/Library/Application Support/typora-user-images/image-20210709235232923.png)

这些乘客分别为:
![image-20210709235304116](/Users/taolei/Library/Application Support/typora-user-images/image-20210709235304116.png)

这些乘客的特征为:

- **出发和到达站点中存在大量空值，空值在出行记录中比例极其高**

- **出发站和到达站中的站点十分分散,即到达的车站特别多，经常去不同的地方作案**

- **行程缺乏接续性（即并不是我们所认为的通勤人员）**

### 5.3 算法结果比对

我们发现两个算法的结果中，dbscan的结果也是孤立森林的异常点，孤立森林多了一个异常点。两个算法得出的共同的异常点为["210623199304049984","220122199211163008","210782199202251008","652925199103260032","410426199105150976"."211021199311224000","210921199209153984","220381199305051008","222401199302180992","372922196510235008"].

这些异常点都有一些共同的特点：

- total_escape_scale比例极其高，意味着这些异常乘客经常逃票。
- 乘坐火车的次数都较多，意味着他们有较多的时间可以作案。
- 所到达的车站数量都多，意味着他们经常更换作案地点防止被抓获。
- 出发站，到达站都有很多空值，意味着他们经常中途下车，作案完成后逃离现场。

